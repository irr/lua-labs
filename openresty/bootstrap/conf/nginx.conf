# openresty -p ~/tmp/ -c `pwd`/conf/nginx.conf

env BASE_PATH;

daemon off;
worker_processes  1;
error_log /dev/stdout info;

events {
    worker_connections 1024;
}

http {
    map "" $base_path {
        default     /home/irocha/github/lua-labs/openresty/bootstrap;
    }

    include         /usr/local/openresty/nginx/conf/mime.types;

    charset         utf-8;
    charset_types   application/json;
    default_type    application/json;

    log_format json_combined escape=json
        '{'
        '"time_local":"$time_local",'
        '"remote_addr":"$remote_addr",'
        '"remote_user":"$remote_user",'
        '"request":"$request",'
        '"status": "$status",'
        '"body_bytes_sent":"$body_bytes_sent",'
        '"request_time":"$request_time",'
        '"http_referrer":"$http_referer",'
        '"http_user_agent":"$http_user_agent"'
        '}';

    access_log /dev/stdout json_combined;

    large_client_header_buffers 4 16k;
    proxy_buffer_size           8k;
    proxy_buffers               8 8k;
    proxy_busy_buffers_size     16k;

    # set search paths for pure Lua external libraries (';;' is the default path):
    lua_package_path '$base_path/?.lua;;';

    # set search paths for Lua external libraries written in C (can also use ';;'):
    lua_package_cpath '$base_path/?.so;;';

    server {
        listen 8080;

        client_max_body_size    10M;
        client_body_buffer_size 64K;

        keepalive_timeout       15;

        location / {
            content_by_lua_file $base_path/main.lua;
        }
    }
}
